# 10. 데이터베이스 테스트

## 10.1 데이터베이스 테스트를 위한 전제 조건
통합 테스트에서는 관리 의존성이 그대로 있어야 한다.

### 10.1.1 데이터베이스를 형상 관리 시스템에 유지 
- 전용 인스턴스를 모델 데이터베이스로 사용하는 것은 안티 패턴
- 데이터베이스 스키마를 Git 같은 형상관리 시스템에 저장하는 것이 최선이다 

### 10.1.2 참조 데이터도 데이터베이스 스키마다 
- 애플리케이션이 데이터를 수정할 수 있음 -> 일반 데이터 / 없음 -> 참조 데이터
- 참조 데이터 : 애플리케이션의 필수 사항으로 `SQL INSERT` 형태로 Git 에 저장되어야 함 

### 10.1.3 모든 개발자를 위한 별도의 데이터베이스 인스턴스
- 공유 데이터베이스가 아닌 개발자 로컬 머신에 구성된 데이터베이스 인스턴스를 사용

### 10.1.4 상태 기반 데이터베이스 배포와 마이그레이션 기반 데이터베이스 배포 


## 10.2 데이터베이스 트랜젝션 관리
- 제품코드에서 트랜잭션 관리를 적절히 하면 데이터 모순을 피할 수 있다. 
- 테스트에서는 운영 환경에 근접한 설정으로 데이터베이스 통합을 검증하는 데 도움이 됨 

### 10.2.1 제품 코드에서 데이터베이스 트랜잭션 관리하기 
- 결정 유형 관리 : 업데이트할 데이터 / 업데이트 유지 또는 롤백 여부  


- Repository : 데이터베이스의 데이터에 대한 접근과 수정을 가능하게 하는 클래스
- 트랜젝션 : 데이터 업데이트를 완전히 commit 하거나 rollback 하는 클래스.  
데이터 수정의 원자성 확보를 위해 기본 데이터베이스 트랜젝션에 의존하는 사용자 정의 클래스
- 레파지토리는 항상 현재 트랜젝션 위에서 작동한다. 


### 10.2.2 통합 테스트에서 데이터베이스 트랜잭션 관리하기 
- 테스트 구절 간에 데이터베이스 트랜젝션이나 작업 단위를 재사용하지 말라 
- 통합 테스트에서 적어도 세 개의 트랜잭션 또는 작업 단위를 사용


## 10.3 테스트 데이터 생명 주기 
- 통합 테스트를 순차적으로 실행
- 테스트 실행 간에 남은 데이터를 제거 

### 10.3.1 병렬 테스트 실행과 순차적 테스트 실행 
- 모든 테스트 데이터가 고유한지 확인해야 데이터베이스 제약 조건을 위반하지 않고 테스트가 다른 테스트 후에 입력 데이터를 잘못 수집하는 일이 없다.
- 도커 컨테이너를 이용해 병렬 처리를 할 수도 있지만 유지보수 부담이 너무 커지게 되고 위험부담이 있다.
- 순차적으로 통합 테스트를 실행하는 것이 더 실용적이다.

### 10.3.2 테스트 실행 간 데이터 정리
- 각 테스트 전에 데이터베이스 백업 복원하기 : 느림 
- 테스트 종료 시점에 데이터 정리하기 : 빠르지만 정리단계를 건너뛰기 쉬움.
- 데이터베이스 트랜젝션에 각 테스트를 래핑하고 커밋하지 않기 : 추가 트랜젝션으로 인해 운영 환경과 다른 설정이 생성될 수 있음
- **테스트 시작 시점에 데이터 정리하기** : 빠르게 작동하고 일관성이 없는 동작을 일으키지 않으며, 정리 단계를 실수로 건너뛰지 않는다

### 10.3.3 인메모리 데이터베이스 피하기 
- 일반 데이터베이스와 기능적으로 일관성이 없기때문에 사용하지 말 것 (환경 비일치)
- 거짓 양성 또는 거짓 음성이 발생하기 쉬움
