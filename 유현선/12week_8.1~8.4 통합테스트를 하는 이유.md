# 8. 통합 테스트를 하는 이유 

## 8.1 통합 테스트는 무엇인가? 

### 8.1.1 통합 테스트의 역할
- 통합 테스트 범주 : 단위 테스트의 3가지 요구 사항(단일 동작 단위를 검증, 빠르게 수행, 다른 테스트와 격리) 중 하나라도 충족하지 못하는 테스트
- 대부분 시스템이 프로세스 외부 의존성과 통합해 어떻게 작동하는지 검증 (= 컨트롤러를 검증)
- 프로세스 외부 의존성과 도메인 모델을 연결하는 코드를 확인 (목으로 대체할수 없는)

### 8.1.2 다시보는 테스트 피라미드
![5_1.png](img%2F5_1.png)
- 단위 테스트와 통합 테스트 간의 균형 유지는 중요 
  - 단위 테스트 : 가능한 많은 비즈니스 시나리오의 예외 상황을 확인
  - 통합 테스트 : 주요 흐름과 단위 테스트가 다루지 못하는 기타 예외 상황을 확인  

### 8.1.3 통합 테스트와 빠른 실패
- 통합 테스트에서 프로세스 외부 의존성과의 상호 작용을 모두 확인하기 위해 가장 긴 주요 흐름을 선택할 것
- ~~좋지 않은 테스트를 작성~~ < 테스트를 작성하지 않음 (가치가 별로 없는 테스트는 좋지 않은 테스트이다)
- 빠른 실패 원칙 : 예기치 않은 오류가 발생하자마자 현재 연산을 중단 > 애플리케이션의 안정성을 높임
  - 피드백 루프 단축
  - 지속성 상태 보호 

## 8.2 어떤 프로세스 외부 의존성을 직접 테스트해야 하는가? 

### 8.2.1 프로세스 외부 의존성의 두 가지 유형 
1) 관리 의존성 (전체를 제어할 수 **있는** 프로세스 외부 의존성)
   - 애플리케이션을 통해서만 접근 가능 (API 제공 등)
   - 해당 의존성과의 상호 작용은 외부 환경에서 볼 수 없음 
   - ex) 데이터베이스
   - 테스트 : 통신이 구현 세부사항이기 때문에 그대로 사용해야 함  

2) 비관리 의존성 (전체를 제어할 수 **없는** 프로세스 외부 의존성)
   - 해당 의존성과의 상호 작용을 외부(other 애플리케이션)에서 볼 수 있음 (부작용 발생)
   - ex) SMTP 서버, 메시지 버스
   - 테스트 : 하위 호환성을 지켜야하는 등의 이유로 mock 을 사용 권장 


### 8.2.2 관리 의존성이면서 비관리 의존성인 프로세스 외부 의존성 다루기 
- 관리 의존성이면서 비관리 의존성인 프로세스 ?? 다른 애플리케이션이 접근할 수 있는 데이터베이스 
  - 이런 구현 방식은 좋지 않음 / 대안 : API, 메세지 버스
- 그러나 이미 일이 발생된 이후라면? 해당 테이블을 비관리 의존성으로 취급하고 테스트 시 mock 을 사용 


### 8.2.3 통합 테스트에서 실제 데이터베이스를 사용할 수 없으면 어떻게 할까?
- 데이터베이스를 그대로 테스트할 수 없으면 통합 테스트를 아예 작성하지 말고 도메인 모델의 단위 테스트에만 집중 
- 가치가 충분하지 않은 테스트는 테스트 스위트에 있으면 안됨

---
## 8.3 통합 테스트: 예제 

### 8.3.1 어떤 시나리오를 테스트할까?
- 통합 테스트 대상 선별 : 가장 긴 주요 흐름과 단위 테스트로는 수행할 수 없는 모든 예외상황 
  - 가장 긴 주요 흐름 : 모든 프로세스 외부 의존성을 거쳐야 함 
  - 빠른 실패 케이스는 테스트 대상이 아님 


### 8.3.2 데이터베이스와 메시지 버스 분류하기 
- 직접 테스트 대상(=관리 의존성, 데이터베이스)과 MOCK 대체 대상(=비관리 의존성, 메시지 버스) 분류 


### 8.3.3 엔드 투 엔드 테스트는 어떤가?
e2e 테스트는 선택사항 
- Do : 배포 후 상태 점검
- Not : 통합 테스트의 보호 수준이 높을 경우


### 8.3.4 통합 테스트 : 첫번째 시도
(테스트 작성 내용)
- Given : 데이터베이스는 직접 사용, 메시지 버스는 Mock 설정 
- When : 실행 
- Then(검증) 
  - 데이터베이스 실제 상태 검증
  - mock 상호 작용 확인 

(개선사항)
- 헨퍼 메서드를 사용하여 검증 구절의 크기 축소
- 회귀 방지 개선 

---

## 8.4 의존성 추상화를 위한 인터페이스 사용 

### 8.4.1 인터페이스와 느슨한 결합 

인터페이스를 사용하는 **(잘못된)** 일반적인 이유
1) ~~프로세스 외부 의존성을 추상화해 느슨한 결합을 달성~~
    - 단일 구현을 위한 인터페이스는 추상화가 아니며, 결합도가 낮지도 않음
    - 진정한 추상화는 발견하는 것이지, 발명하는 것이 아니다
    - 인터페이스가 진정으로 추상화되려면 구현이 적어도 2개 이상은 있어야함
2) ~~기존 코드를 변경하지 않고 새로운 기능을 추가해 공개 폐쇄 원칙(OCP) 을 지킴~~
    - 기본적인 원칙 YAGNI(You aren't gonna need it)를 위반
      - YAGNI : 현재 필요하지 않은 기능에 시간을 들이지 말라 
      - 기회비용 X | 처음부터 실제 필요에 따라 기능을 구현하는 것이 더 유리
      - 프로젝트 코드가 적을수록 더 좋음


### 8.4.2 프로세스 외부 의존성에 인터페이스를 사용하는 이유는 무엇인가? 
- why ? mock 을 사용하기 위해, 인터페이스가 없으면 테스트 대역을 만들 수 없으므로 테스트 대상 시스템과 프로세스 외부 의존성 간의 상호작용을 확인할 수 없음 
  - 비관리 의존성만 인터페이스를 사용 


### 8.4.3 프로세스 내부 의존성을 위한 인터페이스 사용 
- 부작용 : 깨지기 쉬운 테스트 -> 리팩토링 내성이 떨어짐  
