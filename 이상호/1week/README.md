# [Unit Testing] 1장 단위 테스트의 목표

이 내용은 [단위 테스트 생산성과 품질을 위한 단위 테스트 원칙과 패턴]을 읽으면서 정리한 내용을 포함하고 있습니다.

- 범위 : 1장 1.1 ~ 1.4

목차는 다음과 같습니다.

- 단위 테스트 현황
- 단위 테스트 목표
- 테스트 스위트 품질 측정을 위한 커버리지 지표
- 무엇이 성공적인 테스트 스위트를 만드는가?
- 정리

## 단위 테스트 현황

많은 개발자들이 단위 테스트 작성을 실천하고 중요성을 알고 있어서 단위 테스트의 적용 문제는 더 이상 논쟁거리가 아니다.

- 주요 논쟁은 `단위 테스트를 작성해야 하는가?` 가 보다는 `좋은 단위 테스트를 작성하는 것은 어떤 의미인가?` 

많은 프로젝트에는

- 자동화된 테스트와
- 많은 테스트가 실행

테스트를 해도 개발자들이 원하는 결과를 얻지 못하는 경우가 많다.

- 새로운 기능을 구현하려면 시간이 많이 들고, 이미 구현된 기능에는 새로운 버그가 지속적으로 나타나게 된다. 
- 도움이 될 것이라 생각하였던 단위 테스트는 이러한 상황에 전혀 도움이 되지 않고 오히려 상황을 더 악화시킨다.

이러한 상황은 누구에게나 처할 수 있는 끔찍한 상황이고, 이는 제대로 작동하지 않는 단위 테스트의 결과이다.

그렇다면 단위 테스트 작성을 통해 우리가 얻고자 하는 것은 무엇일까?

## 단위 테스트 목표

단위테스트의 목표는 소프트웨어 프로젝트의 지속 가능한 성장을 가능하게 하는 것이다.

### 단위 테스트와 코드 설계의 관계

코드를 단위 테스트하기 어렵다면 코드 개선이 반드시 필요하다는 것을 의미한다. 

개발하고 있는 코드가 다음과 같은 예시에 속하는지 블로그를 참고해보자. 

- [1. 테스트하기 좋은 코드 - 테스트하기 어려운 코드](https://jojoldu.tistory.com/674)
- [@SpyBean @MockBean 의도적으로 사용하지 않기](https://jojoldu.tistory.com/320)

의존성으로 인하여 테스트 코드 작성이 어렵다면 다음과 같은 구조를 조심해야 한다.

- `강한결합`에서 많이 나타나게 된다.
- `강한결합`이란? 제품 코드가 서로 충분히 분리되지 않아서 따로 테스트하기 어려운 구조

### 좋은 단위 테스트 스위트 

- 개발 속도를 지키면서 침체 단계에 빠지지 않게 한다.
- 변경 사항이 회귀로 이어지지 않는다. 
- 코드를 리팩토링하거나 새로운 기능을 추가하는 것이 더 쉬워진다.

### 테스트가 없는 일반 프로젝트의 성장 추이

- 처음에는 발목을 잡을 것이 없으므로 빨리 시작
  - 아직 잘못된 아키텍처 결정이 없고, 걱장할 만한 코드가 있지 않다.
- 시간이 지나면서 점점 더 많은 시간을 들여야 처음에 보여준 것(품질 + 시간)과 같은 정도의 진척을 내게 된다.
- 결국 개발 속도가 현저히 느려지고, 심지어 전혀 진행하지 못할 정도로 느려질 수도 있다.

### 소프트웨어 엔트로피

**소프트웨어 엔트로피는 개발 속도가 빠르게 감소하는 현상을 말한다.**

- 지속적인 정리와 리팩토링 등과 같은 적절한 관리를 하지 않고 방치하면 시스템이 점점 더 복잡해지고 무질서해진다.
- 하나의 버그를 수정하면 더 많은 버그를 양산하고, 소프트웨어의 한 부분을 수정하면 다른 부분들이 고장난다.
- 코드 베이스를 신뢰할 수 없게 되며, 제일 안 좋은 것은 안정화가 어렵게 된다.

**이러한 현상은 테스트를 통해 관리할 수 있다.**

- 테스트는 안전망 역할을 하며, 대부분의 회귀에 대한 보험을 제공하는 도구이다.
- 테스트는 새로운 기능을 도입하거나 새로운 요구 사항에 더 잘 맞게 리팩터링한 후에도 기존 기능이 잘 작동하는지 확인하는데 도움이 된다.
- 지속성과 확장성이 핵심이며, 이를 통해 장기적으로 개발 속도를 유지 가능하다.

### 좋은 테스트와 좋지 않은 테스트를 가르는 요인

**테스트가 잘못 작성된 프로젝트는 다음과 같다.**

- 초반에는 테스트가 잘 작성된 프로젝트의 속성을 보여준다.
- 결국 침체 단계에 빠지게 된다.
- 프로젝트에 테스트를 더 많이 실행하더라도 단위 테스트의 목표를 달성할 수 없다.

**테스트의 비용 요소는 다음과 같은 다양한 활동에 필요한 시간에 따라 결정된다.**

- 기반 코드를 리팩터링할 때 테스트도 리팩터링하라.
- 각 코드 변경 시 테스트를 실행하라.
- 테스트가 잘못된 경고를 발생시킬 경우 처리하라.
- 기반 코드가 어떻게 동작하는지 이해하려고 할 때는 테스트를 읽는 데 시간을 투자하라.

지속 가능한 프로젝트 성장을 위해서는 고품질 테스트에만 집중해야 한다. 고품질 테스트만이 테스트 스위트에 남을 만한 테스트 유형이다.

#### 제품 코드 대 테스트 코드

**가능한 한 적은 코드로 문제를 해결한다.**

- 테스트가 많으면 많을수록 좋다고 생각할 수 있지만 그렇지 않다. 
- 코드는 자산이 아니라 책임이다.
- 코드가 더 많아질수록 소프트웨어 내의 잠재적인 버그에 노출되는 표면적이 더 넓어지고 프로젝트 유지비가 증가하게 된다. 

**애플리케이션의 정확성을 보장한다.**

- 테스트 역시 코드이다. 
- 특정 문제를 해결하는 것을 목표로 코드베이스의 일부로 봐야 한다. 
- 다른 코드와 마찬가지로 단위 테스트도 버그에 취약하고 유지 보수가 필요하다.

## 테스트 스위트 품질 측정을 위한 커버리지 지표

커버리지 지표는 테스트 스위트가 소스 코드를 얼마나 실행하는지를 백분율로 나타낸다.
커버리지 지표는 중요한 피드백을 주더라도 테스트 스위트 품질을 효과적으로 측정하는 데 사용될 수 없다.

**즉, 커버리지 지표는 괜찮은 부정 지표이지만 좋지 않은 긍정 지표다.**

### 코드 커버리지

- 하나 이상의 테스트로 실행된 코드 라인 수와 제품 코드베이스의 전체 라인 수의 비율로 나타낸다.
- 코드가 작을수록 테스트 커버리지 지표는 더 좋아지는데, 이는 원래 라인 수만 처리하기 때문이다.
- 코드를 작게 한다고 테스트 스위트의 가치나 기반 코드 베이스의 유지 보수성이 변경되지는 않는다.

### 분기 커버리지

- 코드 커버리지의 단점을 극복하는 데 도움이 되므로 코드 커버리지보다 더 정확한 결과를 제공한다.
- 테스트 스위트 내 하나 이상의 테스트가 통과하는 제어 구조의 수를 나타낸다.

### 커버리지 지표에 관한 문제점

테스트 스위트의 품질을 결정하는데 어떤 커버리지 지표도 의존할 수 없는 이유는 다음과 같다.

- 테스트 대상 시스템의 모든 가능한 결과를 검증한다고 보장할 수 없다.
  - 부분적인 테스트만 진행
  - 검증이 없는 테스트
- 외부 라이브러리의 코드 경로를 고려할 수 있는 커버리지 지표는 없다.
  - 숨겨진 코드 경로 등

이러한 지표는 단위 테스트가 얼마나 좋은지 나쁜지를 판단할 수 없으며, 커버리지 지표로 테스트가 철저한지 또는 테스트가 충분한지 알 수 없다.

### 특정 커버리지 숫자를 목표로 하기

커버리지 지표를 보는 가장 좋은 방법은 지표 그 자체로 보는 것이며, 목표로 여겨서는 안된다.

**특정 커버리지 숫자를 목표로 하는 것**

- 단위 테스트의 목표와 반대되는 그릇된 동기 부여가 된다.
  - 커버리지 통과를 위한 인위적인 단위 테스트작성
- 개발자들은 중요한 것을 테스트하는 데 집중하는 대신 인공적인 목표를 달성하기 위한 방법을 찾기 시작한다. 
  - 중요하지 않은 기능에도 단위 테스트 작성

**커버리지 지표는 좋은 부정 지표이지만 나쁜 긍정 지표**

- 커버리지 숫자가 낮으면 문제 징후라 할 수 있다.
- 코드베이스에 테스트되지 않은 코드가 많다는 뜻이다. 
- 그러나 높은 숫자도 별 의미는 없다. 
- 그러므로 코드 커버리지를 측정하는 것은 품질 테스트 스위트로 가는 첫걸음일 뿐이다.

## 무엇이 성공적인 테스트 스위트를 만드는가?

**성공적인 테스트 스위트의 특성**

- 개발 주기에 통합되어 있다.
- 코드베이스에서 가장 중요한 부분만을 대상으로 한다.
- 최소한의 유지비로 최대의 가치를 끌어낸다.

#### 개발 주기에 통합돼 있음

**자동화된 테스트를 할 수 있는 방법**

- 끊임없이 하는 것을 목표
- 모든 테스트는 개발 주기에 통합
- 코드가 변경될 때마다 아무리 작은 것이라도 실행

> `CI/CD`(Continuous Integration/Continuous Delivery)를 구축하였다는 것은 devops만의 일이 아닌 개발자의 산출물(단위 / 통합 테스트 작성)이 작성되었다는 것이다.

#### 코드베이스에서 가장 중요한 부분만을 대상으로 함

**시스템에서 가장 중요한 부분은 비즈니스 로직이 있는 도메인 모델**

- 시스템의 가장 중요한 부분
- 가장 많은 단위 테스트 노력이 필요

다른 부분은 간략하게 또는 간접적으로 검증하는 것이 좋다.

> 모든 단위 테스트코드를 작성하는 것이 아닌 핵심 비즈니스 로직의 focus를 맞춘다.

#### 최소한의 유지비로 최대의 가치를 끌어냄

- 가치 있는 테스트(더 나아가, 가치가 낮은 테스트) 식별하기
- 가치 있는 테스트 작성하기

> 복잡한 레거시 코드를 리팩토링하기 위해선 안전망 역할의 단위 테스트 코드가 필요하다.

## 정리

- 단위 테스트 작성의 중요성과 좋은 단위 테스트를 작성하는 것
  - 단위 테스트
- 단위 테스트의 목표는 소프트웨어 프로젝트가 지속적으로 성장하게 만드는 것
- 좋은 단위 테스트 스위트는 개발 속도를 지키면서 침체 단계에 빠지지 않게 한다.
- 성공적인 테스트 스위트
  - 개발 주기에 통합
  - 코드베이스 중 가장 중요한 부분만을 대상
  - 최소한의 유지비로 최대의 가치를 끌어냄
- 단위 테스트의 목표를 달성하기 위한 방법
  - 좋은 테스트와 좋지 않은 테스트를 구별하는 방법을 배운다.
  - 테스트를 리팩토링해서 더 가치 있게 만든다.